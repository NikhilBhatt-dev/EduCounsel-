<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - EduCounsele</title>
    <link rel="stylesheet" href="./css/dashboard.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">EduCounsel</div>
            <div class="nav-user">
                <span id="userName">Loading...</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="welcome-section">
            <h1>Welcome to Your Dashboard</h1>
            <p>Complete your profile and track your admission process</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" data-tab="profile">Profile</button>
            <button class="tab-button" data-tab="academics">Academics</button>
            <button class="tab-button" data-tab="status">Admission Status</button>
            <button class="tab-button" data-tab="payment">Payment</button>
        </div>

        <!-- Profile Tab -->
        <div class="tab-content active" id="profile">
            <h2>Personal Information</h2>
            <form id="personalInfoForm">
                <div class="form-section">
                    <h3>Basic Details</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="dateOfBirth">Date of Birth</label>
                            <input type="date" id="dateOfBirth" name="dateOfBirth">
                        </div>
                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender" name="gender">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select id="category" name="category">
                                <option value="">Select Category</option>
                                <option value="General">General</option>
                                <option value="OBC">OBC</option>
                                <option value="SC">SC</option>
                                <option value="ST">ST</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Contact Details</h3>
                    <div class="form-group">
                        <label for="address">Address</label>
                        <input type="text" id="address" name="address" placeholder="Enter your full address">
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="parentName">Parent/Guardian Name</label>
                            <input type="text" id="parentName" name="parentName">
                        </div>
                        <div class="form-group">
                            <label for="parentPhone">Parent/Guardian Phone</label>
                            <input type="tel" id="parentPhone" name="parentPhone">
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn">Save Personal Information</button>
            </form>
        </div>

        <!-- Academics Tab -->
        <div class="tab-content" id="academics">
            <h2>Academic Information</h2>
            <form id="academicForm">
                <div class="form-section">
                    <h3>High School Marks (Class 10)</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="hsMath">Mathematics</label>
                            <input type="number" id="hsMath" name="hsMath" max="100" min="0">
                        </div>
                        <div class="form-group">
                            <label for="hsScience">Science</label>
                            <input type="number" id="hsScience" name="hsScience" max="100" min="0">
                        </div>
                        <div class="form-group">
                            <label for="hsEnglish">English</label>
                            <input type="number" id="hsEnglish" name="hsEnglish" max="100" min="0">
                        </div>
                        <div class="form-group">
                            <label for="hsHindi">Hindi</label>
                            <input type="number" id="hsHindi" name="hsHindi" max="100" min="0">
                        </div>
                        <div class="form-group">
                            <label for="hsSocial">Social Science</label>
                            <input type="number" id="hsSocial" name="hsSocial" max="100" min="0">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>10+2 Marks (Class 12)</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="physics">Physics</label>
                            <input type="number" id="physics" name="physics" max="100" min="0">
                        </div>
                        <div class="form-group">
                            <label for="chemistry">Chemistry</label>
                            <input type="number" id="chemistry" name="chemistry" max="100" min="0">
                        </div>
                        <div class="form-group">
                            <label for="mathematics">Mathematics</label>
                            <input type="number" id="mathematics" name="mathematics" max="100" min="0">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Branch Preferences</h3>
                    <div class="form-group">
                        <label for="branch1">First Preference</label>
                        <select id="branch1" name="branch1">
                            <option value="">Select Branch</option>
                            <option value="Computer Science Engineering">Computer Science Engineering</option>
                            <option value="Electronics Engineering">Electronics Engineering</option>
                            <option value="Mechanical Engineering">Mechanical Engineering</option>
                            <option value="Civil Engineering">Civil Engineering</option>
                            <option value="Information Technology">Information Technology</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="branch2">Second Preference</label>
                        <select id="branch2" name="branch2">
                            <option value="">Select Branch</option>
                            <option value="Computer Science Engineering">Computer Science Engineering</option>
                            <option value="Electronics Engineering">Electronics Engineering</option>
                            <option value="Mechanical Engineering">Mechanical Engineering</option>
                            <option value="Civil Engineering">Civil Engineering</option>
                            <option value="Information Technology">Information Technology</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn">Save Academic Information</button>
            </form>
        </div>

        <!-- Status Tab -->
        <div class="tab-content" id="status">
            <h2>Admission Status</h2>
            
            <div class="progress-indicator">
                <div class="progress-line"></div>
                <div class="progress-step">
                    <div class="step-circle" id="step1">1</div>
                    <span>Application</span>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="step2">2</div>
                    <span>Review</span>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="step3">3</div>
                    <span>Seat Allocation</span>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="step4">4</div>
                    <span>Payment</span>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="step5">5</div>
                    <span>Admission</span>
                </div>
            </div>

            <div id="statusContent">
                <div class="alert alert-info">
                    <strong>Status:</strong> Please complete your profile and academic information first.
                </div>
            </div>
        </div>

        <!-- Payment Tab -->
        <div class="tab-content" id="payment">
            <h2>Payment Information</h2>
            
            <div id="paymentContent">
                <div class="alert alert-warning">
                    <strong>Note:</strong> Payment section will be available after seat allocation.
                </div>
            </div>

            <div id="paymentForm" style="display: none;">
                <div class="alert alert-success">
                    <strong>Congratulations!</strong> You have been allocated a seat. Please proceed with the payment.
                </div>

                <div class="form-section">
                    <h3>Payment Details</h3>
                    <p>Please deposit the admission fee and upload the payment receipt.</p>
                    
                    <div class="file-upload">
                        <input type="file" id="paymentReceipt" accept=".pdf,.jpg,.jpeg,.png">
                        <label for="paymentReceipt" class="upload-label">
                            ðŸ“Ž Click to upload payment receipt
                        </label>
                        <p style="margin-top: 0.5rem; color: #718096; font-size: 0.9rem;">
                            Supported formats: PDF, JPG, PNG (Max 5MB)
                        </p>
                    </div>

                    <button type="button" class="btn" onclick="uploadPaymentReceipt()" style="margin-top: 1rem;">
                        Upload Receipt
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let studentData = null;

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || !user.id) {
                window.location.href = '/login';
                return;
            }

            if (user.role === 'admin') {
                window.location.href = '/admin';
                return;
            }

            currentUser = user;
            document.getElementById('userName').textContent = user.name;

            // Set up tab event listeners
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName, this);
                });
            });

            // Load student data
            await loadStudentData();
        });

        // Tab functionality
        function showTab(tabName, buttonElement) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            if (buttonElement) {
                buttonElement.classList.add('active');
            }
        }

        // Load student data
        async function loadStudentData() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/student/details', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    studentData = await response.json();
                    populateForm();
                    updateStatus();
                } else if (response.status === 404) {
                    // No student data exists yet - this is normal for new users
                    console.log('No student data found yet - user can start filling forms');
                    studentData = null;
                    updateStatus();
                } else {
                    console.error('Error loading student data:', response.statusText);
                }
            } catch (error) {
                console.error('Error loading student data:', error);
            }
        }

        // Populate form with existing data
        function populateForm() {
            if (!studentData) return;

            // Personal info
            const personalInfo = studentData.personalInfo;
            if (personalInfo) {
                document.getElementById('dateOfBirth').value = personalInfo.dateOfBirth ? personalInfo.dateOfBirth.split('T')[0] : '';
                document.getElementById('gender').value = personalInfo.gender || '';
                document.getElementById('category').value = personalInfo.category || '';
                document.getElementById('address').value = personalInfo.address || '';
                document.getElementById('parentName').value = personalInfo.parentName || '';
                document.getElementById('parentPhone').value = personalInfo.parentPhone || '';
            }

            // High school marks
            const hsMarks = studentData.highSchoolMarks;
            if (hsMarks) {
                document.getElementById('hsMath').value = hsMarks.math || '';
                document.getElementById('hsScience').value = hsMarks.science || '';
                document.getElementById('hsEnglish').value = hsMarks.english || '';
                document.getElementById('hsHindi').value = hsMarks.hindi || '';
                document.getElementById('hsSocial').value = hsMarks.socialScience || '';
            }

            // 10+2 marks
            const plus2Marks = studentData.plus2Marks;
            if (plus2Marks) {
                document.getElementById('physics').value = plus2Marks.physics || '';
                document.getElementById('chemistry').value = plus2Marks.chemistry || '';
                document.getElementById('mathematics').value = plus2Marks.mathematics || '';
            }

            // Branch preferences
            const preferences = studentData.branchPreferences;
            if (preferences && preferences.length > 0) {
                document.getElementById('branch1').value = preferences[0] || '';
                document.getElementById('branch2').value = preferences[1] || '';
            }
        }

        // Update status display
        function updateStatus() {
            const statusContent = document.getElementById('statusContent');
            const paymentContent = document.getElementById('paymentContent');
            const paymentForm = document.getElementById('paymentForm');

            if (!studentData) {
                statusContent.innerHTML = `
                    <div class="alert alert-info">
                        <strong>Status:</strong> Please complete your profile and academic information first.
                    </div>
                `;
                return;
            }

            // Update progress steps
            document.getElementById('step1').classList.add('completed');
            
            if (studentData.rank) {
                document.getElementById('step2').classList.add('completed');
                
                statusContent.innerHTML = `
                    <div class="status-card">
                        <h3>Application Submitted Successfully!</h3>
                        <p>Your Rank: ${studentData.rank}</p>
                        <p>Total Marks (10+2): ${studentData.plus2Marks.total}/300</p>
                        <p>Percentage: ${studentData.plus2Marks.percentage.toFixed(2)}%</p>
                    </div>
                `;

                if (studentData.allocatedBranch) {
                    document.getElementById('step3').classList.add('completed');
                    
                    if (!studentData.seatAccepted) {
                        statusContent.innerHTML += `
                            <div class="alert alert-success">
                                <strong>Seat Allocated:</strong> ${studentData.allocatedBranch}
                                <br><br>
                                <button class="btn btn-success" onclick="acceptSeat()">Accept Seat</button>
                            </div>
                        `;
                    } else {
                        document.getElementById('step4').classList.add('current');
                        
                        paymentContent.style.display = 'none';
                        paymentForm.style.display = 'block';
                        
                        if (studentData.paymentStatus === 'verified') {
                            document.getElementById('step4').classList.remove('current');
                            document.getElementById('step4').classList.add('completed');
                            document.getElementById('step5').classList.add('completed');
                            
                            statusContent.innerHTML += `
                                <div class="alert alert-success">
                                    <strong>Admission Confirmed!</strong> Your offer letter has been generated.
                                    <br><br>
                                    <a href="/uploads/${studentData.offerLetter}" target="_blank" class="btn">Download Offer Letter</a>
                                </div>
                            `;
                        } else if (studentData.paymentStatus === 'submitted') {
                            statusContent.innerHTML += `
                                <div class="alert alert-info">
                                    <strong>Payment Submitted:</strong> Your payment is under verification.
                                </div>
                            `;
                        }
                    }
                }
            }
        }

        // Form submissions
        document.getElementById('personalInfoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await saveStudentData();
        });

        document.getElementById('academicForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await saveStudentData();
        });

        // Save student data
        async function saveStudentData() {
            const personalInfo = {
                dateOfBirth: document.getElementById('dateOfBirth').value,
                gender: document.getElementById('gender').value,
                category: document.getElementById('category').value,
                address: document.getElementById('address').value,
                parentName: document.getElementById('parentName').value,
                parentPhone: document.getElementById('parentPhone').value
            };

            const highSchoolMarks = {
                math: parseFloat(document.getElementById('hsMath').value) || 0,
                science: parseFloat(document.getElementById('hsScience').value) || 0,
                english: parseFloat(document.getElementById('hsEnglish').value) || 0,
                hindi: parseFloat(document.getElementById('hsHindi').value) || 0,
                socialScience: parseFloat(document.getElementById('hsSocial').value) || 0
            };

            const plus2Marks = {
                physics: parseFloat(document.getElementById('physics').value) || 0,
                chemistry: parseFloat(document.getElementById('chemistry').value) || 0,
                mathematics: parseFloat(document.getElementById('mathematics').value) || 0
            };

            const branchPreferences = [
                document.getElementById('branch1').value,
                document.getElementById('branch2').value
            ].filter(branch => branch);

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/student/details', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        personalInfo,
                        highSchoolMarks,
                        plus2Marks,
                        branchPreferences
                    })
                });

                if (response.ok) {
                    alert('Information saved successfully!');
                    await loadStudentData();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.message || 'Failed to save information'));
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        // Accept seat
        async function acceptSeat() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/student/accept-seat', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('Seat accepted successfully!');
                    await loadStudentData();
                } else {
                    alert('Error accepting seat');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        // Upload payment receipt
        async function uploadPaymentReceipt() {
            const fileInput = document.getElementById('paymentReceipt');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file to upload');
                return;
            }

            const formData = new FormData();
            formData.append('receipt', file);

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/student/payment-receipt', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    alert('Payment receipt uploaded successfully!');
                    await loadStudentData();
                } else {
                    alert('Error uploading receipt');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }


        document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  window.location.href = 'login.html';
});

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = './login.html';

        }
    </script>
</body>
</html>